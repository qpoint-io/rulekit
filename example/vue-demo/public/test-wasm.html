<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rulekit WASM Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #42b883;
            margin-top: 0;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #42b883;
            border-radius: 4px;
        }
        .test-case.pass {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }
        .test-case.fail {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .test-case h3 {
            margin-top: 0;
            font-size: 16px;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 12px;
        }
        .status.pass {
            background: #4caf50;
            color: white;
        }
        .status.fail {
            background: #f44336;
            color: white;
        }
        .status.loading {
            background: #ff9800;
            color: white;
        }
        .status.error {
            background: #9e9e9e;
            color: white;
        }
        button {
            background: #42b883;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px 0;
        }
        button:hover {
            background: #35a373;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #output {
            margin-top: 20px;
        }
        .init-status {
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .init-status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .init-status.loading {
            background: #fff3e0;
            color: #e65100;
        }
        .init-status.error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Rulekit WASM Test</h1>
        
        <div id="init-status" class="init-status loading">
            ‚è≥ Initializing WASM module...
        </div>

        <button id="run-tests" disabled>Run Tests</button>
        
        <div id="output"></div>
    </div>

    <script src="/wasm_exec.js"></script>
    <script>
        const output = document.getElementById('output');
        const initStatus = document.getElementById('init-status');
        const runButton = document.getElementById('run-tests');

        async function init() {
            try {
                const go = new Go();
                const response = await fetch('/rulekit.wasm');
                const buffer = await response.arrayBuffer();
                const result = await WebAssembly.instantiate(buffer, go.importObject);
                
                // Run Go program
                go.run(result.instance);
                
                // Wait for module to be ready
                let attempts = 0;
                while (!window.rulekit && attempts < 100) {
                    await new Promise(r => setTimeout(r, 10));
                    attempts++;
                }
                
                if (window.rulekit) {
                    initStatus.className = 'init-status success';
                    initStatus.textContent = '‚úÖ WASM module initialized successfully!';
                    runButton.disabled = false;
                } else {
                    throw new Error('Module did not initialize');
                }
            } catch (error) {
                initStatus.className = 'init-status error';
                initStatus.textContent = '‚ùå Failed to initialize: ' + error.message;
                console.error(error);
            }
        }

        async function runTests() {
            output.innerHTML = '';
            runButton.disabled = true;

            const tests = [
                {
                    name: 'Simple equality',
                    rule: 'domain == "example.com"',
                    context: { domain: 'example.com' },
                    expectedPass: true
                },
                {
                    name: 'String contains',
                    rule: 'path contains "/api"',
                    context: { path: '/api/v1/users' },
                    expectedPass: true
                },
                {
                    name: 'Number comparison',
                    rule: 'status >= 200 && status < 300',
                    context: { status: 200 },
                    expectedPass: true
                },
                {
                    name: 'Boolean AND',
                    rule: 'is_admin && is_active',
                    context: { is_admin: true, is_active: true },
                    expectedPass: true
                },
                {
                    name: 'Boolean OR',
                    rule: 'method == "GET" || method == "POST"',
                    context: { method: 'POST' },
                    expectedPass: true
                },
                {
                    name: 'Regex match',
                    rule: 'email matches /^[a-z]+@[a-z]+\\.[a-z]+$/',
                    context: { email: 'user@example.com' },
                    expectedPass: true
                },
                {
                    name: 'Array membership',
                    rule: 'status in [200, 201, 204]',
                    context: { status: 201 },
                    expectedPass: true
                },
                {
                    name: 'Negative test',
                    rule: 'port == 443',
                    context: { port: 80 },
                    expectedPass: false
                },
                {
                    name: 'Parse error',
                    rule: 'invalid syntax ==',
                    context: {},
                    expectError: true
                }
            ];

            for (const test of tests) {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                
                let statusClass = 'loading';
                let statusText = '‚è≥ RUNNING';
                let details = '';

                try {
                    // Parse
                    const parsed = window.rulekit.parse(test.rule);
                    
                    if (parsed.error) {
                        if (test.expectError) {
                            statusClass = 'pass';
                            statusText = '‚úÖ PASS';
                            details = `Expected error received:\n${parsed.error}`;
                        } else {
                            statusClass = 'error';
                            statusText = '‚ùå ERROR';
                            details = `Parse error: ${parsed.error}`;
                        }
                    } else {
                        // Parse AST
                        let ast = parsed.ast;
                        if (typeof ast === 'string') {
                            ast = JSON.parse(ast);
                        }

                        // Evaluate
                        const contextJSON = JSON.stringify(test.context);
                        const result = window.rulekit.eval(parsed.handle, contextJSON);
                        
                        // Check result
                        const passed = result.pass === test.expectedPass;
                        statusClass = passed ? 'pass' : 'fail';
                        statusText = passed ? '‚úÖ PASS' : '‚ùå FAIL';
                        
                        details = `Rule: ${parsed.ruleString}\n`;
                        details += `Context: ${contextJSON}\n`;
                        details += `Result: ${result.pass ? 'PASS' : 'FAIL'}\n`;
                        details += `Evaluated: ${result.evaluatedRule}\n`;
                        details += `AST: ${JSON.stringify(ast, null, 2)}`;

                        // Free handle
                        window.rulekit.free(parsed.handle);
                    }
                } catch (error) {
                    statusClass = 'error';
                    statusText = '‚ùå ERROR';
                    details = `Exception: ${error.message}\n${error.stack}`;
                }

                testDiv.className = 'test-case ' + statusClass;
                testDiv.innerHTML = `
                    <h3>
                        ${test.name}
                        <span class="status ${statusClass}">${statusText}</span>
                    </h3>
                    <pre>${details}</pre>
                `;
                
                output.appendChild(testDiv);
            }

            runButton.disabled = false;
        }

        runButton.addEventListener('click', runTests);
        init();
    </script>
</body>
</html>

